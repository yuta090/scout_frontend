# Airwork認証機能の対応策

## 検出された問題

1. **APIエンドポイント変更**
   - Airworkサイトの認証APIエンドポイントが変更されている可能性があります
   - `/airplf/api/v1/auth/login`や`/api/auth/login`などの想定されるエンドポイントでアクセスできませんでした
   - `/auth/sign-in`ページにもアクセスできず、ログイン方法が変更された可能性があります

2. **ログインフロー変更**
   - インタラクションページにログインリンクが見つかりませんでした
   - 認証フローがSPA（シングルページアプリケーション）形式に変更された可能性があります

3. **Netlify Functions環境の問題**
   - Chromiumパッケージが正しくインストールされていない、または互換性の問題があります
   - Netlify関数のローカル実行環境でパッケージの依存関係が正しく解決されていません

## 推奨する対応策

### 1. Airworkサイトの最新のログイン方法を調査

1. **手動確認による調査**
   - ブラウザで実際にAirworkサイトにアクセスし、現在のログインフローを確認します
   - Devツールを使用して実際のAPIエンドポイントとリクエスト構造をキャプチャします

2. **最新のAirworkドキュメントの確認**
   - Airworkが公式に提供している開発者向けドキュメントがあれば確認します
   - 認証方法が変更されていないか調査します

### 2. 認証ロジックの修正

1. **Puppeteerアプローチの強化**
   - 現在のHTMLからユーザーインターフェースを解析し、ログインボタンや入力フォームを動的に検出します
   - シングルページアプリケーションでのログインフローに対応できるように改善します

2. **クロスサイトリクエストの改善**
   - Airwork側でのCORS制限を回避するためのヘッダー設定を見直します
   - プロキシアプローチを検討して、サーバー側からのリクエストとして認証を行うことを検討します

### 3. 開発環境の改善

1. **パッケージインストールの修正**
   ```bash
   cd netlify/functions/check-airwork-auth
   npm install @sparticuz/chromium puppeteer-core axios --save
   ```

2. **プロジェクト構造の整理**
   - `.netlify/functions-serve`ディレクトリが正しく設定されているか確認します
   - Netlify CLIのバージョンを確認し、必要に応じて更新します

3. **デバッグ情報の強化**
   - Netlify Functionへのリクエスト時にデバッグモードを有効にします
   - Chromiumの起動パラメータを最適化して、エラーの詳細を取得します

### 4. 代替アプローチの検討

1. **Airworkの公式APIを利用**
   - Airworkが公式に提供しているAPIがあれば、それを利用することを検討します
   - APIキーやOAuthなどの認証方法を調査します

2. **認証プロキシサービスの構築**
   - 別のプラットフォーム（AWS Lambda、Google Cloud Functions）での実装を検討します
   - より柔軟なリソース制限のあるサービスを選択します

3. **ブラウザ自動化からAPI連携への変更**
   - Puppeteerベースのアプローチから、直接APIを呼び出すアプローチに変更します
   - セッション管理やトークン認証に対応した実装を検討します

## 次のステップ

1. 実際のAirworkサイトでの認証フローを手動で確認
2. Devツールを使用して実際のAPIリクエストとレスポンスをキャプチャ
3. Netlify Functionsの設定とパッケージを修正
4. 新しい認証フローに基づいてコードを更新
5. テスト計画を策定し、変更の有効性を検証

これらの手順により、Airworkの認証機能を正常に動作させるための対策を講じることができます。 