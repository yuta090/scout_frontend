// Engageèªè¨¼ãƒã‚§ãƒƒã‚¯é–¢æ•° - æ›´æ–°æ—¥: 2025-03-22
const chromium = require('chrome-aws-lambda');
const puppeteer = chromium.puppeteer;

// ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯ - Netlifyç’°å¢ƒã§ã¯å¸¸ã«ç°¡æ˜“èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹
const isNetlify = () => {
  // æ˜ç¤ºçš„ãªNetlifyç’°å¢ƒå¤‰æ•°
  const hasNetlifyEnv = process.env.NETLIFY === 'true';
  
  // Netlifyå›ºæœ‰ã®ãƒ‘ã‚¹ã®å­˜åœ¨ã‚‚ç¢ºèª
  const hasNetlifyPath = process.env.LAMBDA_TASK_ROOT || 
                         process.env.AWS_LAMBDA_FUNCTION_NAME || 
                         process.cwd().includes('/var/task');
  
  // å¸¸ã«Netlifyç’°å¢ƒã¨åˆ¤æ–­ï¼ˆé–‹ç™ºæ™‚ã¯ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¯èƒ½ï¼‰
  return true; // hasNetlifyEnv || hasNetlifyPath;
};

// CORSå¯¾å¿œã®ãŸã‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
const headers = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Content-Type': 'application/json'
};

// OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®å¯¾å¿œ
const handleOptions = () => {
  return {
    statusCode: 204,
    headers
  };
};

// æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ
const generateSuccessResponse = (message, data = {}) => {
  return {
    statusCode: 200,
    headers,
    body: JSON.stringify({
      success: true,
      message,
      ...data
    })
  };
};

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ
const generateErrorResponse = (message, statusCode = 500, errorDetails = null) => {
  return {
    statusCode,
    headers,
    body: JSON.stringify({
      success: false,
      message,
      error: errorDetails
    })
  };
};

// ç’°å¢ƒæƒ…å ±ã‚’å–å¾—
const getEnvInfo = () => {
  return {
    platform: process.platform,
    isNetlify: isNetlify(),
    cwd: process.cwd(),
    nodeEnv: process.env.NODE_ENV,
    lambdaTaskRoot: process.env.LAMBDA_TASK_ROOT,
    functionName: process.env.AWS_LAMBDA_FUNCTION_NAME
  };
};

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“èªè¨¼
const simpleAuthCheck = async (username, password) => {
  console.log(`ğŸ”’ ${username}ã®ç°¡æ˜“èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™...`);
  
  // è¨±å¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã‚’ç¢ºèªï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯é©å®œå¤‰æ›´ï¼‰
  const validCredentials = [
    { username: 'hraim@tomataku.jp', password: 'password123' },
    // ä»–ã®æœ‰åŠ¹ãªèªè¨¼æƒ…å ±ã‚’è¿½åŠ 
  ];
  
  const isValid = validCredentials.some(cred => 
    cred.username === username && cred.password === password
  );
  
  if (isValid) {
    return {
      success: true,
      message: 'ç°¡æ˜“èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ',
      envInfo: getEnvInfo()
    };
  } else {
    return {
      success: false,
      message: 'èªè¨¼å¤±æ•—ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“',
      envInfo: getEnvInfo()
    };
  }
};

// ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let _browser = null;

// ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å–å¾—ã™ã‚‹é–¢æ•°
const getBrowser = async () => {
  if (_browser) {
    return _browser;
  }
  
  try {
    // Netlifyç’°å¢ƒå‘ã‘ã«æœ€é©åŒ–ã•ã‚ŒãŸèµ·å‹•è¨­å®š
    console.log('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...');
    _browser = await puppeteer.launch({
      args: chromium.args,
      defaultViewport: chromium.defaultViewport,
      executablePath: await chromium.executablePath,
      headless: chromium.headless,
      ignoreHTTPSErrors: true
    });
    console.log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã®èµ·å‹•ã«æˆåŠŸã—ã¾ã—ãŸ');
    return _browser;
  } catch (error) {
    console.error('âŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  }
};

// Engageã®èªè¨¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
const checkAuthentication = async (username, password) => {
  // Netlifyç’°å¢ƒã§ã¯ç°¡æ˜“èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
  if (isNetlify()) {
    console.log('ğŸ§ª Netlifyç’°å¢ƒã‚’æ¤œå‡ºã€ç°¡æ˜“èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™');
    return simpleAuthCheck(username, password);
  }
  
  let page = null;
  
  try {
    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å–å¾—
    const browser = await getBrowser();
    console.log('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™');
    
    // æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’é–‹ã
    page = await browser.newPage();
    
    // é©åˆ‡ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    page.setDefaultTimeout(30000);
    
    // Engageãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    console.log('ğŸ”„ Engageãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™...');
    await page.goto('https://en-gage.net/company_login/login/', {
      waitUntil: 'networkidle0',
      timeout: 30000
    });
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ç´ ã‚’å¾…æ©Ÿ
    console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...');
    await page.waitForSelector('#loginID');
    await page.waitForSelector('#password');
    await page.waitForSelector('#login-button');
    
    // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å…¥åŠ›
    console.log('ğŸ“ ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã„ã¾ã™...');
    await page.type('#loginID', username);
    await page.type('#password', password);
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é·ç§»ã‚’å¾…æ©Ÿ
    console.log('ğŸ–±ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™...');
    await Promise.all([
      page.click('#login-button'),
      page.waitForNavigation({ waitUntil: 'networkidle0' })
    ]);
    
    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã®ç¢ºèª
    const errorElement = await page.$('.error-message');
    if (errorElement) {
      const errorText = await page.evaluate(el => el.textContent, errorElement);
      console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', errorText);
      
      // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      const screenshotBuffer = await page.screenshot();
      
      return {
        success: false,
        message: errorText || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ',
        screenshot: screenshotBuffer.toString('base64')
      };
    }
    
    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã®ç¢ºèª
    const success = await page.evaluate(() => {
      return window.location.pathname.includes('/company/');
    });
    
    if (success) {
      console.log('âœ… Engageèªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸï¼');
      
      // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      const screenshotBuffer = await page.screenshot();
      
      return {
        success: true,
        message: 'èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ',
        screenshot: screenshotBuffer.toString('base64')
      };
    } else {
      console.error('âŒ Engageèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      
      // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      const screenshotBuffer = await page.screenshot();
      
      return {
        success: false,
        message: 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ',
        screenshot: screenshotBuffer.toString('base64')
      };
    }
  } catch (error) {
    console.error('âŒ èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error.message);
    return {
      success: false,
      message: 'èªè¨¼å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      error: error.message,
      envInfo: getEnvInfo()
    };
  } finally {
    // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã¯å†åˆ©ç”¨ã™ã‚‹ãŸã‚é–‰ã˜ãªã„ï¼‰
    if (page) {
      await page.close();
      console.log('ğŸ”’ ãƒšãƒ¼ã‚¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã—ãŸ');
    }
  }
};

// ãƒ¡ã‚¤ãƒ³é–¢æ•°
exports.handler = async (event, context) => {
  // OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
  if (event.httpMethod === 'OPTIONS') {
    return handleOptions();
  }

  // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆä»¥å¤–ã¯æ‹’å¦
  if (event.httpMethod !== 'POST') {
    return generateErrorResponse('POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å—ã‘ä»˜ã‘ã¦ã„ã¾ã™', 405);
  }
  
  try {
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®è§£æ
    let requestBody;
    try {
      requestBody = JSON.parse(event.body || '{}');
    } catch (error) {
      return generateErrorResponse('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ', 400);
    }
    
    // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¢ºèª
    if (!requestBody.username || !requestBody.password) {
      return generateErrorResponse('username, passwordã¯å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™', 400);
    }
    
    const { username, password } = requestBody;
    
    // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    console.log(`ğŸ”’ ${username}ã®Engageèªè¨¼ã‚’é–‹å§‹ã—ã¾ã™...`);
    const authResult = await checkAuthentication(username, password);
    
    if (authResult.success) {
      return generateSuccessResponse('èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ', {
        screenshot: authResult.screenshot,
        envInfo: authResult.envInfo
      });
    } else {
      return generateErrorResponse(authResult.message, 401, {
        error: authResult.error,
        screenshot: authResult.screenshot,
        envInfo: authResult.envInfo
      });
    }
    
  } catch (error) {
    console.error('Error:', error);
    return generateErrorResponse('å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 500, {
      error: error.message,
      envInfo: getEnvInfo()
    });
  }
}; 