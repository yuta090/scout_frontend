# Airwork認証APIテスト結果

## 問題の概要

Supabase Edge Functionで実装した`check-airwork-auth`関数が、Airwork APIへの接続に失敗している問題を調査しました。

## テスト結果サマリー

### 1. ローカル環境からのAirwork API直接テスト

```
ステータスコード: 404
エラーデータ: "<!DOCTYPE html><html><head><meta charSet=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width\"/><title>お探しのページは見つかりませんでした</title>..."
```

**結果**: ❌ 失敗
**原因**: APIエンドポイントが見つからないか、変更されている可能性があります。

### 2. Supabase Edge Function経由のテスト

```
ステータスコード: 500
エラーデータ: {
  "success": false,
  "message": "認証サーバーへの接続に失敗しました",
  "details": {
    "status": "network_error",
    "code": "NETWORK_ERROR",
    "timestamp": "2025-03-21T05:26:50.464Z"
  }
}
```

**結果**: ❌ 失敗
**原因**: Supabase Edge Function (Cloudflare Workers上で動作) からのネットワーク接続が失敗しています。

### 3. ネットワーク接続テスト

```
DNS解決成功: ats.rct.airwork.net -> 54.230.129.2 (IPv4)
TCP接続テスト中...
ats.rct.airwork.net:443 への接続成功!
```

**結果**: ✅ 成功
**意味**: クライアント側からの通常のネットワーク接続自体は問題ありません。

### 4. TLS設定テスト

```
TLSバージョン: 1.3
暗号スイート: TLSv1.3 / AEAD-AES128-GCM-SHA256 / [blank] / UNDEF
```

**結果**: ✅ 成功
**意味**: TLSバージョンとサイファースイートの互換性に問題はありません。

## 問題の原因分析

### 主要な問題点

1. **APIエンドポイントの変更**: Airworkの認証APIエンドポイントが変更された可能性があります。直接テストでは404エラーが返っており、エンドポイントが存在しないか移動している可能性があります。

2. **Cloudflare Workers環境の制限**: Supabase Edge FunctionsはCloudflare Workers上で動作しており、特定のドメインへのアクセス制限がある可能性があります。これはネットワークエラーの主要な原因と考えられます。

3. **プロキシの必要性**: Cloudflare Workers環境からの外部APIへの直接アクセスは制限されている可能性があり、プロキシの使用が必要な場合があります。

## 推奨される解決策

1. **プロキシサーバーの導入**:
   - Netlify FunctionsやAWS Lambdaなど、より制限の少ないサーバーレス環境を使用してプロキシを実装
   - プロキシサーバーがAirwork APIにリクエストを転送する構成に変更

2. **Airwork API仕様の確認**:
   - 最新のAPI仕様書を確認して、エンドポイントURLやリクエスト形式が変更されていないか確認
   - テスト環境でAPIの動作を検証

3. **代替認証方法の検討**:
   - AirworkがAPI認証以外の方法（OAuth連携など）を提供している場合は、その方法への切り替えを検討
   - スクレイピングなどの代替手段も検討

## 次のステップ

1. プロキシサーバーアプローチの実装と検証
2. Airworkの技術サポートに問い合わせ、APIの仕様変更や推奨される連携方法を確認
3. Supabaseサポートに問い合わせ、Edge Functionsからの外部APIアクセスに関する制限について確認

## 技術的詳細

### ネットワーク接続テスト結果

ドメインへのDNS解決とTCP接続テストはすべて成功しており、基本的なネットワーク接続性には問題がありません。

### HTTP/TLS検証結果

AirworkサーバーはTLS 1.3をサポートしており、現代的な暗号スイートを使用しています。TLS設定の非互換性は問題の原因ではないと思われます。

### 考えられるCloudflare Workers制限

- 特定のドメインや国へのアクセス制限
- ファイアウォールやセキュリティポリシーによるブロック
- 長時間実行リクエストの制限（タイムアウト設定）

### APIエンドポイント変更の可能性

テストの結果、直接APIエンドポイントへのアクセスでも404エラーが返されたため、APIエンドポイントが変更されている可能性が高いです。Airworkの最新のAPI仕様を確認する必要があります。 